<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Study demo" />
    <meta name="author" content="lf" />

	<title th:text="#{Study}"></title>

	<!-- 引入样式 -->
	<link rel="stylesheet" type="text/css" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"/>
	<link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_226046_ud7r7if5kyajdcxr.css"/>
	<link rel="stylesheet" type="text/css" href="/css/normalize.css"/>
	<link rel="stylesheet" type="text/css" href="/css/main.css"/>

	<!-- 全局变量设置 -->
	<script type="text/javascript">
        /*<![CDATA[*/
        var appMsg = {
            loadingMsg: "[[#{请求处理中}]]",
            systemAlterTitle: "[[#{系统提示}]]",
            systemAlterButton: "[[#{返回登录界面}]]",
            systemAlterTimeoutMsg: "[[#{服务器连接超时，请重新登录}]]",
            systemAlterNoPermissionsMsg: "[[#{您因权限不足，无法访问该资源}]]"
        }

        var appCsrf = {
            csrf_parameter: "[[${_csrf.parameterName}]]",
            csrf_header: "[[${_csrf.headerName}]]",
            csrf_token: "[[${_csrf.token}]]"
        }
        /*]]>*/
	</script>

	<!-- 引入组件库 -->
	<script type="text/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue"></script>
	<script type="text/javascript" src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script type="text/javascript" src="/js/axiosUtil.js"></script>

</head>
<body>
	<div id="app" class="contain">
		<el-container>
			<el-header>
			</el-header>

			<el-container>
				<el-aside width="200px">
					<el-menu default-active="1" @select="handleSelect">
						<el-submenu :index="menu1" v-for="menu1 in menuList">
							<template slot="title">
								<i class="el-icon-location"></i>
								<span>{{ menu1.menuNm }}</span>
							</template>
							
							<el-menu-item v-if="menu2.subMenu.length == 0" :index="menu2" v-for="menu2 in menu1.subMenu">
								<template slot="title">
									<i class="el-icon-location"></i>
									<span>{{ menu2.menuNm }}</span>
								</template>
							</el-menu-item>
							
							<el-submenu v-else :index="menu2" v-for="menu2 in menu1.subMenu">
								<template slot="title">
									<i class="el-icon-location"></i>
									<span>{{ menu2.menuNm }}</span>
								</template>
								
								<el-menu-item v-if="menu3.subMenu.length == 0" :index="menu3" v-for="menu3 in menu2.subMenu">
									<template slot="title">
										<i class="el-icon-location"></i>
										<span>{{ menu3.menuNm }}</span>
									</template>
								</el-menu-item>
								
								<el-submenu v-else :index="menu3" v-for="menu3 in menu2.subMenu">
									<template slot="title">
										<i class="el-icon-location"></i>
										<span>{{ menu3.menuNm }}</span>
									</template>
									
									<el-menu-item :index="menu4" v-for="menu4 in menu3.subMenu">
										<template slot="title">
											<i class="el-icon-location"></i>
											<span>{{ menu4.menuNm }}</span>
										</template>
									</el-menu-item>
							
								</el-submenu>
							</el-submenu>
						</el-submenu>
					</el-menu>
				</el-aside>

				<el-main>
					<el-tabs v-model="activiTab" type="card" closable @tab-remove="removeTab">
						<el-tab-pane v-for="(item, index) in tabs" :key="item.name" :label="item.title" :name="item.name" v-html="item.content">
						</el-tab-pane>
					</el-tabs>
				</el-main>
				
			</el-container>
		</el-container>
    </div>

	<script type="text/javascript">
	/*<![CDATA[*/
		console.log(1);
		var vue = new Vue({
			el: '#app',
			data: function() {
				return {
					menuList: null,	// 菜单列表数据
					tabs: [],		// 标签列表数据
					activiTab: ''	// 当前标签
				}
			},
			beforeCreate: function () {
				// 取得菜单
				axiosUtil.post("/mainMenu", null, function (result) {
					vue.menuList = result;
				}, this, true);
			},
			methods: {
				// 选择菜单事件
				handleSelect(menu) {
					this.addTab(menu.menuCd, menu.menuNm, menu.menuUrl.resourceUrl);
				},
				// 添加标签事件
				addTab(menuCd, menuNm, menuUrl) {
					// 判断是否为已打开的标签，已打开的标签直接选择标签
					let isOpend = false;
					this.tabs.forEach((tab, index) => {
						if (menuCd === tab.name) {
							isOpend = true;
						}
					});
					
					// 未打开时添加
					if (!isOpend) {
						// 取得菜单
						axiosUtil.post("/main", null, function (result) {
							vue.tabs.push({
								title: menuNm,
								name: menuCd,
								content: result
							});
						}, this, true);
					}
					// 保存当前标签
					this.activiTab = menuCd;
				},
				// 删除标签事件
				removeTab(key) {
					let tabs = this.tabs;
					let activiTab = this.activiTab;
					if (key === this.activiTab) {
						tabs.forEach((tab, index) => {
							if (key === tab.name) {
								let nextTab = tabs[index + 1] || tabs[index - 1];
								if (nextTab) activiTab = nextTab.name;
							}
						});
					}
			        this.activiTab = activiTab;
			        this.tabs = tabs.filter(tab => tab.name !== key);
				}
		    }
		});
	/*]]>*/
	</script>
</body>
</html>